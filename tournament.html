<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournament</title>

<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">

<h1 id="title"></h1>

<div id="fixtures" class="section active">
<h2>Fixtures</h2>
<button class="add-match-btn" onclick="openAdd()">+ Add Match</button>
<div id="fixturesList"></div>
</div>

<div id="scores" class="section">
<h2>Scores</h2>
<div id="scoresList"></div>
</div>

<div id="table" class="section">
<h2>Standings</h2>
<table>
<thead>
<tr>
<th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th>
<th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
</tr>
</thead>
<tbody id="standings"></tbody>
</table>
</div>

</div>

<nav class="navbar">
<div class="nav-item active" onclick="show('fixtures',this)">Fixtures</div>
<div class="nav-item" onclick="show('scores',this)">Scores</div>
<div class="nav-item" onclick="show('table',this)">Table</div>
</nav>

<!-- ADD MATCH -->
<div id="addModal" class="modal">
<div class="modal-content">
<h3>Add Match</h3>
<input id="roundInput" type="number" value="1">
<select id="home"></select>
<select id="away"></select>
<button onclick="closeAll()">Cancel</button>
<button onclick="saveMatch()">Save</button>
</div>
</div>

<!-- RESULT -->
<div id="resultModal" class="modal">
<div class="modal-content">
<h3>Enter Result</h3>
<input id="sh" type="number" placeholder="Home goals">
<input id="sa" type="number" placeholder="Away goals">
<button onclick="closeAll()">Cancel</button>
<button onclick="saveResult()">Confirm</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore,doc,onSnapshot,updateDoc,arrayUnion } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyBYFoGEfyxSc_8h_GryQ4HXk9UDZf6I9Vc",
authDomain:"football-manager-a8c11.firebaseapp.com",
projectId:"football-manager-a8c11",
storageBucket:"football-manager-a8c11.appspot.com",
messagingSenderId:"78452499051",
appId:"1:78452499051:web:5f26427727d1d17024c72e"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const id=new URLSearchParams(location.search).get("id");
const ref=doc(db,"tournaments",id);

let T=null;
let currentIndex=null;

onSnapshot(ref,s=>{
if(!s.exists())return;
T=s.data();
render();
});

function render(){

title.innerText=T.name;

home.innerHTML="";
away.innerHTML="";
T.teams.forEach(t=>{
home.innerHTML+=`<option>${t}</option>`;
away.innerHTML+=`<option>${t}</option>`;
});

fixturesList.innerHTML="";
scoresList.innerHTML="";

const stats={};
T.teams.forEach(t=>{
stats[t]={p:0,w:0,d:0,l:0,gf:0,ga:0};
});

if(T.matches){

T.matches.forEach((m,i)=>{

if(m.scoreHome!=null){

scoresList.innerHTML+=`
<div class="match-card">
${m.home} ${m.scoreHome} - ${m.scoreAway} ${m.away}
</div>`;

let h=stats[m.home], a=stats[m.away];
h.p++;a.p++;
h.gf+=m.scoreHome;h.ga+=m.scoreAway;
a.gf+=m.scoreAway;a.ga+=m.scoreHome;

if(m.scoreHome>m.scoreAway){h.w++;a.l++;}
else if(m.scoreHome<m.scoreAway){a.w++;h.l++;}
else{h.d++;a.d++;}

}else{

fixturesList.innerHTML+=`
<div class="match-card">
<span onclick="openResult(${i})">${m.home} vs ${m.away}</span>
<button class="del" onclick="del(${i})">X</button>
</div>`;
}

});
}

const arr=Object.entries(stats).map(([k,v])=>{
v.team=k;
v.gd=v.gf-v.ga;
v.pts=v.w*3+v.d;
return v;
});

arr.sort((a,b)=>b.pts-a.pts||b.gd-a.gd||b.gf-a.gf);

standings.innerHTML="";
arr.forEach(t=>{
standings.innerHTML+=`
<tr>
<td>${t.team}</td><td>${t.p}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td>
<td>${t.gf}</td><td>${t.ga}</td><td>${t.gd}</td><td>${t.pts}</td>
</tr>`;
});
}

window.show=(id,e)=>{
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
e.classList.add("active");
};

window.openAdd=()=>addModal.style.display="block";
window.closeAll=()=>{addModal.style.display=resultModal.style.display="none"}

window.saveMatch=async()=>{
if(home.value==away.value)return alert("Same team!");
await updateDoc(ref,{
matches:arrayUnion({
round:+roundInput.value,
home:home.value,
away:away.value,
scoreHome:null,
scoreAway:null
})
});
closeAll();
};

window.del=async(i)=>{
T.matches.splice(i,1);
await updateDoc(ref,{matches:T.matches});
};

window.openResult=i=>{
currentIndex=i;
resultModal.style.display="block";
};

window.saveResult=async()=>{
T.matches[currentIndex].scoreHome=+sh.value;
T.matches[currentIndex].scoreAway=+sa.value;
await updateDoc(ref,{matches:T.matches});
closeAll();
};

</script>
</body>
 </html>


